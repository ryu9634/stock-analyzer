<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ê¸‰ë“±ì£¼ ì˜ˆì¸¡ê¸° v4 - Low Cap US Stocks</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&family=JetBrains+Mono:wght@400;500&display=swap');

  * { margin: 0; padding: 0; box-sizing: border-box; }

  :root {
    --bg: #0a0e17;
    --bg2: #0f172a;
    --card: #111827;
    --card-hover: #1a2332;
    --border: #1e2d3d;
    --text: #e2e8f0;
    --text-dim: #94a3b8;
    --accent: #3b82f6;
    --green: #10b981;
    --red: #ef4444;
    --orange: #f59e0b;
    --purple: #a78bfa;
    --cyan: #22d3ee;
  }

  [data-theme="light"] {
    --bg: #f1f5f9;
    --bg2: #e2e8f0;
    --card: #ffffff;
    --card-hover: #f8fafc;
    --border: #cbd5e1;
    --text: #1e293b;
    --text-dim: #64748b;
    --accent: #2563eb;
    --green: #059669;
    --red: #dc2626;
    --orange: #d97706;
    --purple: #7c3aed;
    --cyan: #0891b2;
  }

  body {
    font-family: 'Noto Sans KR', -apple-system, sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    padding: 0;
    transition: background 0.3s, color 0.3s;
  }

  .header {
    background: linear-gradient(135deg, var(--bg2) 0%, #1e1b4b 50%, var(--bg2) 100%);
    border-bottom: 1px solid var(--border);
    padding: 24px 32px;
    position: sticky;
    top: 0;
    z-index: 100;
    backdrop-filter: blur(20px);
  }

  [data-theme="light"] .header {
    background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 50%, #e0e7ff 100%);
  }

  .header-inner {
    max-width: 1600px;
    margin: 0 auto;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 12px;
  }

  .header h1 {
    font-size: 22px;
    font-weight: 700;
    background: linear-gradient(135deg, #60a5fa, #a78bfa, #f472b6);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }

  .header-sub {
    font-size: 12px;
    color: var(--text-dim);
    margin-top: 2px;
  }

  .header-meta {
    font-size: 13px;
    color: var(--text-dim);
    display: flex;
    gap: 16px;
    align-items: center;
  }

  .status-dot {
    width: 8px; height: 8px;
    background: var(--green);
    border-radius: 50%;
    display: inline-block;
    animation: pulse 2s infinite;
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.4; }
  }

  .theme-toggle {
    background: var(--card);
    border: 1px solid var(--border);
    color: var(--text);
    padding: 6px 10px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 16px;
    transition: all 0.2s;
  }
  .theme-toggle:hover { border-color: var(--accent); }

  .container {
    max-width: 1600px;
    margin: 0 auto;
    padding: 24px;
  }

  .summary-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 12px;
    margin-bottom: 20px;
  }

  .summary-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 16px;
    text-align: center;
    transition: background 0.3s;
  }

  .summary-card .label {
    font-size: 11px;
    color: var(--text-dim);
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-bottom: 6px;
  }

  .summary-card .value {
    font-size: 24px;
    font-weight: 700;
    font-family: 'JetBrains Mono', monospace;
  }

  .summary-card .sub {
    font-size: 11px;
    color: var(--text-dim);
    margin-top: 4px;
  }

  /* ì„¹í„° íˆíŠ¸ë§µ */
  .sector-heatmap {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 16px;
    margin-bottom: 20px;
  }

  .sector-heatmap h3 {
    font-size: 13px;
    color: var(--text-dim);
    margin-bottom: 12px;
    text-transform: uppercase;
    letter-spacing: 1px;
  }

  .heatmap-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
  }

  .heatmap-cell {
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 11px;
    font-weight: 500;
    cursor: pointer;
    transition: transform 0.15s;
    white-space: nowrap;
  }

  .heatmap-cell:hover { transform: scale(1.05); }

  .heatmap-cell .hm-name { display: block; }
  .heatmap-cell .hm-count {
    font-family: 'JetBrains Mono', monospace;
    font-size: 10px;
    opacity: 0.8;
  }

  .filters {
    display: flex;
    gap: 8px;
    margin-bottom: 20px;
    flex-wrap: wrap;
    align-items: center;
  }

  .filter-btn {
    padding: 8px 16px;
    border-radius: 8px;
    border: 1px solid var(--border);
    background: var(--card);
    color: var(--text-dim);
    font-size: 13px;
    cursor: pointer;
    transition: all 0.2s;
    font-family: inherit;
  }

  .filter-btn:hover { border-color: var(--accent); color: var(--text); }
  .filter-btn.active {
    background: var(--accent);
    border-color: var(--accent);
    color: white;
  }

  .export-btn {
    padding: 8px 16px;
    border-radius: 8px;
    border: 1px solid var(--border);
    background: var(--card);
    color: var(--cyan);
    font-size: 13px;
    cursor: pointer;
    font-family: inherit;
    margin-left: auto;
    transition: all 0.2s;
  }
  .export-btn:hover { border-color: var(--cyan); }

  .search-box {
    padding: 8px 16px;
    border-radius: 8px;
    border: 1px solid var(--border);
    background: var(--card);
    color: var(--text);
    font-size: 13px;
    width: 200px;
    font-family: inherit;
    outline: none;
    transition: border-color 0.2s;
  }

  .search-box:focus { border-color: var(--accent); }

  .table-wrap {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 12px;
    overflow: hidden;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 14px;
  }

  thead th {
    background: var(--bg2);
    padding: 14px 10px;
    text-align: left;
    font-weight: 500;
    color: var(--text-dim);
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    position: sticky;
    top: 0;
    cursor: pointer;
    user-select: none;
    white-space: nowrap;
  }

  thead th:hover { color: var(--accent); }
  thead th.sorted { color: var(--accent); }

  tbody tr {
    border-bottom: 1px solid var(--border);
    transition: background 0.15s;
  }

  tbody tr:hover { background: var(--card-hover); }

  td {
    padding: 8px 10px;
    white-space: nowrap;
  }

  .rank {
    font-family: 'JetBrains Mono', monospace;
    font-weight: 700;
    color: var(--text-dim);
    width: 36px;
  }

  .rank-1 { color: #fbbf24; }
  .rank-2 { color: #d1d5db; }
  .rank-3 { color: #d97706; }

  .star-btn {
    background: none;
    border: none;
    cursor: pointer;
    font-size: 16px;
    padding: 2px;
    opacity: 0.3;
    transition: opacity 0.15s;
  }
  .star-btn:hover { opacity: 0.7; }
  .star-btn.active { opacity: 1; }

  .stock-info {
    display: flex;
    flex-direction: column;
    gap: 2px;
    max-width: 180px;
  }

  .stock-name {
    font-weight: 500;
    font-size: 13px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .stock-ticker {
    font-family: 'JetBrains Mono', monospace;
    font-size: 11px;
    color: var(--text-dim);
    display: flex;
    align-items: center;
    gap: 4px;
  }

  .new-badge {
    background: rgba(59,130,246,0.2);
    color: #60a5fa;
    font-size: 9px;
    padding: 1px 4px;
    border-radius: 3px;
    font-weight: 700;
  }

  .persist-badge {
    background: rgba(245,158,11,0.15);
    color: #fbbf24;
    font-size: 9px;
    padding: 1px 4px;
    border-radius: 3px;
  }

  .sparkline-cell {
    width: 80px;
    height: 28px;
  }

  .sparkline-cell canvas {
    width: 80px;
    height: 28px;
  }

  .score-cell {
    font-family: 'JetBrains Mono', monospace;
    font-weight: 700;
    font-size: 16px;
  }

  .score-bar-container {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .score-bar {
    width: 50px;
    height: 6px;
    background: var(--bg2);
    border-radius: 3px;
    overflow: hidden;
  }

  .score-bar-fill {
    height: 100%;
    border-radius: 3px;
    transition: width 0.5s ease;
  }

  .signal-badge {
    padding: 4px 10px;
    border-radius: 6px;
    font-size: 12px;
    font-weight: 500;
    white-space: nowrap;
  }

  .signal-strong-buy { background: rgba(239,68,68,0.15); color: #f87171; }
  .signal-buy { background: rgba(245,158,11,0.15); color: #fbbf24; }
  .signal-neutral { background: rgba(148,163,184,0.15); color: #94a3b8; }
  .signal-weak { background: rgba(59,130,246,0.15); color: #60a5fa; }

  .return-cell {
    font-family: 'JetBrains Mono', monospace;
    font-size: 12px;
  }

  .positive { color: var(--green); }
  .negative { color: var(--red); }

  .vol-badge {
    font-family: 'JetBrains Mono', monospace;
    font-size: 12px;
    padding: 2px 6px;
    border-radius: 4px;
  }

  .vol-high { background: rgba(245,158,11,0.15); color: #fbbf24; }
  .vol-normal { color: var(--text-dim); }

  .sub-scores {
    display: flex;
    gap: 10px;
    font-size: 11px;
  }

  .sub-score {
    display: flex;
    align-items: center;
    gap: 3px;
  }

  .sub-score-label { color: var(--text-dim); }
  .sub-score-val { font-family: 'JetBrains Mono', monospace; font-weight: 500; }

  .mcap-cell {
    font-family: 'JetBrains Mono', monospace;
    font-size: 12px;
    color: var(--cyan);
  }

  .show-more-wrap {
    text-align: center;
    padding: 20px;
  }

  .show-more-btn {
    padding: 12px 32px;
    border-radius: 8px;
    border: 1px solid var(--border);
    background: var(--card);
    color: var(--text);
    font-size: 14px;
    cursor: pointer;
    font-family: inherit;
    transition: all 0.2s;
  }
  .show-more-btn:hover { border-color: var(--accent); color: var(--accent); }

  .modal-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.7);
    z-index: 200;
    justify-content: center;
    align-items: center;
    padding: 20px;
  }

  .modal-overlay.show { display: flex; }

  .modal {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 16px;
    max-width: 700px;
    width: 100%;
    max-height: 85vh;
    overflow-y: auto;
    padding: 28px;
  }

  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
  }

  .modal-close {
    background: none;
    border: none;
    color: var(--text-dim);
    font-size: 24px;
    cursor: pointer;
  }

  .detail-section {
    margin-bottom: 20px;
  }

  .detail-section h3 {
    font-size: 14px;
    color: var(--accent);
    margin-bottom: 12px;
    padding-bottom: 6px;
    border-bottom: 1px solid var(--border);
  }

  .detail-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 6px 0;
    border-bottom: 1px solid rgba(255,255,255,0.03);
  }

  .detail-item-name { color: var(--text-dim); font-size: 13px; }
  .detail-item-score {
    font-family: 'JetBrains Mono', monospace;
    font-weight: 500;
    font-size: 14px;
  }

  .detail-item-val {
    font-size: 11px;
    color: var(--text-dim);
    margin-left: 8px;
  }

  .detail-bar {
    width: 80px;
    height: 4px;
    background: var(--bg2);
    border-radius: 2px;
    margin-left: 12px;
    overflow: hidden;
  }

  .detail-bar-fill {
    height: 100%;
    border-radius: 2px;
  }

  .loading {
    text-align: center;
    padding: 80px 20px;
    color: var(--text-dim);
  }

  .loading-spinner {
    width: 40px;
    height: 40px;
    border: 3px solid var(--border);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto 16px;
  }

  @keyframes spin { to { transform: rotate(360deg); } }

  .empty-state {
    text-align: center;
    padding: 60px 20px;
    color: var(--text-dim);
  }

  .refresh-bar {
    font-size: 11px;
    color: var(--text-dim);
    text-align: right;
    margin-bottom: 8px;
  }

  @media (max-width: 768px) {
    .container { padding: 12px; }
    .header { padding: 16px; }
    .header h1 { font-size: 18px; }
    .summary-grid { grid-template-columns: repeat(2, 1fr); gap: 8px; }
    .summary-card { padding: 12px; }
    .summary-card .value { font-size: 20px; }
    table { font-size: 12px; }
    td, thead th { padding: 6px 4px; }
    .sub-scores { display: none; }
    .hide-mobile { display: none; }
    .sparkline-cell { display: none; }
    .sector-heatmap { display: none; }
    .search-box { width: 140px; }
  }
</style>
</head>
<body>

<div class="header">
  <div class="header-inner">
    <div>
      <h1>ê¸‰ë“± ì˜ˆì¸¡ê¸° v4 - Pre-Surge Detector</h1>
      <div class="header-sub">ë¯¸êµ­ ì†Œí˜•ì£¼ (ì‹œì´ &lt; $2B) | ë³€ë™ì„± + ë§¤ì§‘ + ì°¨íŠ¸íŒ¨í„´ + ê¸°ìˆ ë¶„ì„ + ì£¼ë´‰ì¶”ì„¸</div>
    </div>
    <div class="header-meta">
      <span><span class="status-dot"></span> ìë™ ì—…ë°ì´íŠ¸</span>
      <span id="updateTime">ë¡œë”© ì¤‘...</span>
      <button class="theme-toggle" onclick="toggleTheme()" title="í…Œë§ˆ ì „í™˜" id="themeBtn">ğŸŒ™</button>
    </div>
  </div>
</div>

<div class="container">
  <div class="refresh-bar" id="refreshBar"></div>

  <div class="summary-grid" id="summaryGrid">
    <div class="summary-card">
      <div class="label">ë¶„ì„ ì¢…ëª©</div>
      <div class="value" id="totalCount">-</div>
      <div class="sub" id="universeSize">-</div>
    </div>
    <div class="summary-card">
      <div class="label">ê¸‰ë“± ì„ë°•</div>
      <div class="value" id="strongBuy" style="color: #f87171">-</div>
      <div class="sub">ì ìˆ˜ 78+</div>
    </div>
    <div class="summary-card">
      <div class="label">ë§¤ì§‘ ì§„í–‰</div>
      <div class="value" id="buyCount" style="color: #fbbf24">-</div>
      <div class="sub">ì ìˆ˜ 68-77</div>
    </div>
    <div class="summary-card">
      <div class="label">ì‹ ê·œ ì‹œê·¸ë„</div>
      <div class="value" id="newSignalCount" style="color: var(--accent)">-</div>
      <div class="sub">ì˜¤ëŠ˜ ìƒˆë¡œ ë“±ì¥</div>
    </div>
    <div class="summary-card">
      <div class="label">Low Float</div>
      <div class="value" id="lowFloatCount" style="color: var(--cyan)">-</div>
      <div class="sub">ìœ ë™ë¹„ìœ¨ &lt; 50%</div>
    </div>
    <div class="summary-card">
      <div class="label">ê³ ë³€ë™ì„±</div>
      <div class="value" id="highVolCount" style="color: var(--purple)">-</div>
      <div class="sub">ë³€ë™ì„± 70+</div>
    </div>
    <div class="summary-card">
      <div class="label">ìˆìŠ¤í€´ì¦ˆ</div>
      <div class="value" id="shortCount" style="color: var(--orange)">-</div>
      <div class="sub">ìˆë¹„ì¤‘ 15%+</div>
    </div>
    <div class="summary-card" id="hitRateCard" style="display:none">
      <div class="label">7ì¼ ì ì¤‘ë¥ </div>
      <div class="value" id="hitRateVal" style="color: var(--green)">-</div>
      <div class="sub" id="hitRateSub">-</div>
    </div>
  </div>

  <div class="sector-heatmap" id="sectorHeatmap" style="display:none">
    <h3>ì„¹í„° íˆíŠ¸ë§µ â€” ì‹œê·¸ë„ ë¶„í¬</h3>
    <div class="heatmap-grid" id="heatmapGrid"></div>
  </div>

  <div class="filters">
    <button class="filter-btn active" data-filter="all">ì „ì²´</button>
    <button class="filter-btn" data-filter="strong">ê¸‰ë“±ì„ë°•</button>
    <button class="filter-btn" data-filter="buy">ë§¤ì§‘ì§„í–‰</button>
    <button class="filter-btn" data-filter="new">ğŸ†• ì‹ ê·œ</button>
    <button class="filter-btn" data-filter="volume">ê±°ë˜ëŸ‰ê¸‰ì¦</button>
    <button class="filter-btn" data-filter="lowfloat">Low Float</button>
    <button class="filter-btn" data-filter="highvol">ê³ ë³€ë™ì„±</button>
    <button class="filter-btn" data-filter="short">ìˆë¹„ì¤‘â†‘</button>
    <button class="filter-btn" data-filter="microcap">Micro Cap</button>
    <button class="filter-btn" data-filter="watchlist">â­ ê´€ì‹¬</button>
    <input type="text" class="search-box" id="searchBox" placeholder="ì¢…ëª©ëª… / í‹°ì»¤ ê²€ìƒ‰...">
    <button class="export-btn" onclick="exportCSV()">ğŸ“¥ CSV</button>
  </div>

  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th data-sort="rank">#</th>
          <th>â­</th>
          <th data-sort="name">ì¢…ëª©</th>
          <th class="hide-mobile">ì°¨íŠ¸</th>
          <th data-sort="market_cap">ì‹œì´</th>
          <th data-sort="total_score">ì¢…í•©ì ìˆ˜</th>
          <th data-sort="signal">ì‹œê·¸ë„</th>
          <th>ì„¸ë¶€ (V/A/P/T)</th>
          <th data-sort="return_1d" class="hide-mobile">1ì¼</th>
          <th data-sort="return_5d" class="hide-mobile">5ì¼</th>
          <th data-sort="return_20d" class="hide-mobile">20ì¼</th>
          <th data-sort="volume_ratio">ê±°ë˜ëŸ‰</th>
        </tr>
      </thead>
      <tbody id="stockTable">
        <tr><td colspan="12" class="loading">
          <div class="loading-spinner"></div>
          ë°ì´í„° ë¡œë”© ì¤‘...
        </td></tr>
      </tbody>
    </table>
  </div>

  <div class="show-more-wrap" id="showMoreWrap" style="display:none">
    <button class="show-more-btn" onclick="showMore()" id="showMoreBtn">ë” ë³´ê¸°</button>
  </div>
</div>

<div class="modal-overlay" id="modalOverlay">
  <div class="modal" id="modalContent"></div>
</div>

<script src="data/analysis.js"></script>
<script>
var allStocks = [];
var currentFilter = 'all';
var currentSort = { key: 'total_score', desc: true };
var displayCount = 100;
var watchlist = getWatchlist();
var refreshTimer = null;

function escapeHtml(str) {
  if (!str) return '';
  var d = document.createElement('div');
  d.textContent = str;
  return d.innerHTML;
}

function getWatchlist() {
  try { return JSON.parse(localStorage.getItem('surge_watchlist') || '[]'); }
  catch(e) { return []; }
}

function saveWatchlist() {
  localStorage.setItem('surge_watchlist', JSON.stringify(watchlist));
}

function toggleWatchlist(ticker, evt) {
  if (evt) evt.stopPropagation();
  var idx = watchlist.indexOf(ticker);
  if (idx >= 0) watchlist.splice(idx, 1);
  else watchlist.push(ticker);
  saveWatchlist();
  renderTable(allStocks);
}

function getScoreColor(score) {
  if (score >= 78) return '#f87171';
  if (score >= 68) return '#fbbf24';
  if (score >= 55) return '#94a3b8';
  if (score >= 40) return '#60a5fa';
  return '#475569';
}

function getSignalClass(signal) {
  if (signal.includes('ê¸‰ë“±')) return 'signal-strong-buy';
  if (signal.includes('ë§¤ì§‘')) return 'signal-buy';
  if (signal.includes('ê´€ì‹¬')) return 'signal-neutral';
  return 'signal-weak';
}

function formatReturn(val) {
  if (val == null) return '<span class="return-cell" style="color:var(--text-dim)">-</span>';
  var cls = val >= 0 ? 'positive' : 'negative';
  return '<span class="' + cls + '">' + (val >= 0 ? '+' : '') + val.toFixed(1) + '%</span>';
}

function drawSparkline(canvasId, data, color) {
  var c = document.getElementById(canvasId);
  if (!c || !data || data.length < 2) return;
  var ctx = c.getContext('2d');
  var w = c.width, h = c.height;
  var step = w / (data.length - 1);
  ctx.clearRect(0, 0, w, h);
  ctx.beginPath();
  ctx.strokeStyle = color;
  ctx.lineWidth = 1.5;
  for (var i = 0; i < data.length; i++) {
    var x = i * step;
    var y = h - (data[i] / 100) * (h - 4) - 2;
    if (i === 0) ctx.moveTo(x, y);
    else ctx.lineTo(x, y);
  }
  ctx.stroke();
}

async function loadData() {
  if (typeof STOCK_DATA !== 'undefined' && STOCK_DATA && STOCK_DATA.stocks) {
    renderDashboard(STOCK_DATA);
    return;
  }
  var paths = ['./data/analysis.json', 'data/analysis.json'];
  for (var p = 0; p < paths.length; p++) {
    try {
      var resp = await fetch(paths[p] + '?t=' + Date.now());
      if (!resp.ok) continue;
      var data = await resp.json();
      if (data && data.stocks) {
        renderDashboard(data);
        return;
      }
    } catch (e) {
      console.log('fetch failed:', paths[p], e.message);
    }
  }
  document.getElementById('stockTable').innerHTML =
    '<tr><td colspan="12" class="empty-state">ë°ì´í„° íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.<br><br><b>í•´ê²°:</b> <code>python analyzer.py</code> ì‹¤í–‰ í›„ ìƒˆë¡œê³ ì¹¨</td></tr>';
  document.getElementById('updateTime').textContent = 'ë°ì´í„° ì—†ìŒ';
}

function renderDashboard(data) {
  var summary = data.summary;
  var stocks = data.stocks;
  allStocks = stocks;
  displayCount = 100;

  document.getElementById('totalCount').textContent = summary.total_analyzed;
  document.getElementById('universeSize').textContent = summary.total_universe ? ('/' + summary.total_universe + ' ìœ ë‹ˆë²„ìŠ¤') : '';
  document.getElementById('strongBuy').textContent = summary.surge_imminent;
  document.getElementById('buyCount').textContent = summary.accumulating;
  document.getElementById('newSignalCount').textContent = summary.new_signal_count || 0;
  document.getElementById('lowFloatCount').textContent = summary.low_float_count || 0;
  document.getElementById('highVolCount').textContent = summary.high_vol_count || 0;
  document.getElementById('shortCount').textContent = summary.short_squeeze_count || 0;
  document.getElementById('updateTime').textContent = summary.updated_at;

  // ì ì¤‘ë¥  ì¹´ë“œ
  var hr = summary.hit_rates;
  if (hr && hr['7d']) {
    document.getElementById('hitRateCard').style.display = '';
    document.getElementById('hitRateVal').textContent = hr['7d'].hit_10pct + '%';
    document.getElementById('hitRateSub').textContent =
      '10%â†‘ ' + hr['7d'].total + 'ê±´ | í‰ê·  ' + (hr['7d'].avg_return >= 0 ? '+' : '') + hr['7d'].avg_return + '%';
  }

  renderSectorHeatmap(stocks);
  renderTable(stocks);
  setupAutoRefresh();
}

function renderSectorHeatmap(stocks) {
  var sectors = {};
  stocks.forEach(function(s) {
    var sec = s.sector;
    if (!sec || sec === '' || sec === 'N/A') return;
    if (!sectors[sec]) sectors[sec] = { count: 0, signals: 0, totalScore: 0 };
    sectors[sec].count++;
    sectors[sec].totalScore += s.total_score;
    if (s.total_score >= 55) sectors[sec].signals++;
  });

  var entries = Object.entries(sectors).filter(function(e) { return e[1].count >= 3; });
  entries.sort(function(a, b) { return b[1].signals - a[1].signals; });

  if (entries.length === 0) return;

  var maxSignals = Math.max.apply(null, entries.map(function(e) { return e[1].signals; }));
  var grid = document.getElementById('heatmapGrid');
  grid.innerHTML = entries.map(function(e) {
    var name = e[0], data = e[1];
    var intensity = maxSignals > 0 ? data.signals / maxSignals : 0;
    var r = Math.round(59 + intensity * 180);
    var g = Math.round(130 - intensity * 80);
    var b = Math.round(246 - intensity * 180);
    var bg = 'rgba(' + r + ',' + g + ',' + b + ',0.2)';
    var color = 'rgb(' + r + ',' + g + ',' + b + ')';
    return '<div class="heatmap-cell" style="background:' + bg + ';color:' + color + '" onclick="filterBySector(\'' + escapeHtml(name) + '\')">' +
      '<span class="hm-name">' + escapeHtml(name) + '</span>' +
      '<span class="hm-count">' + data.signals + ' signals / ' + data.count + '</span>' +
    '</div>';
  }).join('');

  document.getElementById('sectorHeatmap').style.display = '';
}

function filterBySector(sectorName) {
  document.getElementById('searchBox').value = sectorName;
  currentFilter = 'all';
  document.querySelectorAll('.filter-btn').forEach(function(b) { b.classList.remove('active'); });
  document.querySelector('.filter-btn[data-filter="all"]').classList.add('active');
  renderTable(allStocks);
}

function renderTable(stocks) {
  var filtered = stocks.slice();
  var search = document.getElementById('searchBox').value.toLowerCase();

  if (currentFilter === 'strong') filtered = filtered.filter(function(s) { return s.total_score >= 78; });
  else if (currentFilter === 'buy') filtered = filtered.filter(function(s) { return s.total_score >= 68 && s.total_score < 78; });
  else if (currentFilter === 'new') filtered = filtered.filter(function(s) { return s.is_new; });
  else if (currentFilter === 'volume') filtered = filtered.filter(function(s) { return s.volume_ratio >= 1.5; });
  else if (currentFilter === 'lowfloat') filtered = filtered.filter(function(s) { return s.float_ratio != null && s.float_ratio < 0.5; });
  else if (currentFilter === 'highvol') filtered = filtered.filter(function(s) { return s.volatility_score != null && s.volatility_score >= 70; });
  else if (currentFilter === 'short') filtered = filtered.filter(function(s) { return s.short_interest != null && s.short_interest >= 10; });
  else if (currentFilter === 'microcap') filtered = filtered.filter(function(s) { return s.market_cap != null && s.market_cap < 300000000; });
  else if (currentFilter === 'watchlist') filtered = filtered.filter(function(s) { return watchlist.indexOf(s.ticker) >= 0; });

  if (search) {
    filtered = filtered.filter(function(s) {
      return s.name.toLowerCase().includes(search) || s.ticker.toLowerCase().includes(search) || (s.sector || '').toLowerCase().includes(search);
    });
  }

  filtered.sort(function(a, b) {
    var va = a[currentSort.key], vb = b[currentSort.key];
    if (va == null) va = -Infinity;
    if (vb == null) vb = -Infinity;
    if (typeof va === 'string') { va = va.toLowerCase(); vb = (vb || '').toLowerCase(); }
    if (va < vb) return currentSort.desc ? 1 : -1;
    if (va > vb) return currentSort.desc ? -1 : 1;
    return 0;
  });

  if (filtered.length === 0) {
    document.getElementById('stockTable').innerHTML =
      '<tr><td colspan="12" class="empty-state">í•´ë‹¹í•˜ëŠ” ì¢…ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
    document.getElementById('showMoreWrap').style.display = 'none';
    return;
  }

  var showing = Math.min(displayCount, filtered.length);
  var sparkIds = [];

  var html = '';
  for (var i = 0; i < showing; i++) {
    var s = filtered[i];
    var rank = i + 1;
    var rankClass = rank <= 3 ? 'rank-' + rank : '';
    var scoreColor = getScoreColor(s.total_score);
    var pct = Math.min(100, s.total_score);
    var volClass = s.volume_ratio >= 1.5 ? 'vol-high' : 'vol-normal';
    var isWatched = watchlist.indexOf(s.ticker) >= 0;
    var sparkId = 'spark_' + i;
    sparkIds.push({ id: sparkId, data: s.sparkline, color: s.return_5d >= 0 ? '#10b981' : '#ef4444' });

    var tickerBadges = '';
    if (s.is_new) tickerBadges += '<span class="new-badge">NEW</span>';
    if (s.signal_days > 1) tickerBadges += '<span class="persist-badge">' + s.signal_days + 'ì¼</span>';

    html += '<tr onclick="showDetail(\'' + escapeHtml(s.ticker) + '\')" style="cursor:pointer">' +
      '<td class="rank ' + rankClass + '">' + rank + '</td>' +
      '<td><button class="star-btn ' + (isWatched ? 'active' : '') + '" onclick="toggleWatchlist(\'' + escapeHtml(s.ticker) + '\',event)">â­</button></td>' +
      '<td>' +
        '<div class="stock-info">' +
          '<span class="stock-name">' + escapeHtml(s.name) + '</span>' +
          '<span class="stock-ticker">' + escapeHtml(s.ticker) + ' ' + tickerBadges + '</span>' +
        '</div>' +
      '</td>' +
      '<td class="sparkline-cell hide-mobile"><canvas id="' + sparkId + '" width="160" height="56"></canvas></td>' +
      '<td class="mcap-cell">' + escapeHtml(s.market_cap_fmt || 'N/A') + '</td>' +
      '<td>' +
        '<div class="score-bar-container">' +
          '<span class="score-cell" style="color:' + scoreColor + '">' + s.total_score + '</span>' +
          '<div class="score-bar">' +
            '<div class="score-bar-fill" style="width:' + pct + '%;background:' + scoreColor + '"></div>' +
          '</div>' +
        '</div>' +
      '</td>' +
      '<td><span class="signal-badge ' + getSignalClass(s.signal) + '">' + escapeHtml(s.signal) + '</span></td>' +
      '<td>' +
        '<div class="sub-scores">' +
          '<div class="sub-score"><span class="sub-score-label">V</span><span class="sub-score-val" style="color:' + getScoreColor(s.volatility_score || 0) + '">' + (s.volatility_score || '-') + '</span></div>' +
          '<div class="sub-score"><span class="sub-score-label">A</span><span class="sub-score-val" style="color:' + getScoreColor(s.accum_score || 0) + '">' + (s.accum_score || '-') + '</span></div>' +
          '<div class="sub-score"><span class="sub-score-label">P</span><span class="sub-score-val" style="color:' + getScoreColor(s.pattern_score || 0) + '">' + (s.pattern_score || '-') + '</span></div>' +
          '<div class="sub-score"><span class="sub-score-label">T</span><span class="sub-score-val" style="color:' + getScoreColor(s.tech_score || 0) + '">' + (s.tech_score || '-') + '</span></div>' +
        '</div>' +
        ((s.flags && s.flags.length > 0) ? '<div style="font-size:10px;margin-top:3px;color:#fbbf24">' + escapeHtml(s.flags[0]) + '</div>' : '') +
      '</td>' +
      '<td class="return-cell hide-mobile">' + formatReturn(s.return_1d) + '</td>' +
      '<td class="return-cell hide-mobile">' + formatReturn(s.return_5d) + '</td>' +
      '<td class="return-cell hide-mobile">' + formatReturn(s.return_20d) + '</td>' +
      '<td><span class="vol-badge ' + volClass + '">' + s.volume_ratio + 'x</span></td>' +
    '</tr>';
  }

  document.getElementById('stockTable').innerHTML = html;

  // ìŠ¤íŒŒí¬ë¼ì¸ ë Œë”
  requestAnimationFrame(function() {
    sparkIds.forEach(function(s) { drawSparkline(s.id, s.data, s.color); });
  });

  // ë”ë³´ê¸° ë²„íŠ¼
  if (showing < filtered.length) {
    document.getElementById('showMoreWrap').style.display = '';
    document.getElementById('showMoreBtn').textContent = 'ë” ë³´ê¸° (' + (filtered.length - showing) + 'ê°œ ë‚¨ìŒ)';
  } else {
    document.getElementById('showMoreWrap').style.display = 'none';
  }
}

function showMore() {
  displayCount += 100;
  renderTable(allStocks);
}

function showDetail(ticker) {
  var stock = allStocks.find(function(s) { return s.ticker === ticker; });
  if (!stock) return;

  function renderDetailSection(title, items) {
    if (!items || items.length === 0) return '';
    var rows = items.map(function(item) {
      var color = getScoreColor(item.score);
      var pct = Math.min(100, item.score);
      return '<div class="detail-item">' +
        '<span class="detail-item-name">' + escapeHtml(item.name) + '</span>' +
        '<div style="display:flex;align-items:center;">' +
          '<span class="detail-item-score" style="color:' + color + '">' + item.score + '</span>' +
          '<span class="detail-item-val">(' + escapeHtml(item.value) + ')</span>' +
          '<div class="detail-bar"><div class="detail-bar-fill" style="width:' + pct + '%;background:' + color + '"></div></div>' +
        '</div>' +
      '</div>';
    }).join('');
    return '<div class="detail-section"><h3>' + escapeHtml(title) + '</h3>' + rows + '</div>';
  }

  var floatDisplay = stock.float_ratio != null ? (stock.float_ratio * 100).toFixed(0) + '%' : 'N/A';
  var isWatched = watchlist.indexOf(stock.ticker) >= 0;

  var flagsHtml = '';
  if (stock.flags && stock.flags.length > 0) {
    flagsHtml = '<div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:16px">';
    stock.flags.forEach(function(f) {
      flagsHtml += '<span style="background:rgba(245,158,11,0.15);color:#fbbf24;padding:4px 10px;border-radius:6px;font-size:12px">' + escapeHtml(f) + '</span>';
    });
    flagsHtml += '</div>';
  }

  var persistHtml = '';
  if (stock.signal_days > 0) {
    persistHtml = '<span style="margin-left:8px;font-size:12px;color:var(--orange)">' +
      (stock.is_new ? 'ğŸ†• ì‹ ê·œ ì‹œê·¸ë„' : stock.signal_days + 'ì¼ ì—°ì†') + '</span>';
  }

  var shortHtml = '';
  if (stock.short_interest != null) {
    shortHtml = '<span>ìˆë¹„ì¤‘: <b style="color:' + (stock.short_interest >= 15 ? 'var(--red)' : 'var(--cyan)') + '">' + stock.short_interest + '%</b></span>';
  }

  var weeklyHtml = '';
  if (stock.weekly_score != null) {
    weeklyHtml = '<span>ì£¼ë´‰: <b style="color:' + getScoreColor(stock.weekly_score) + '">' + stock.weekly_score + '</b></span>';
  }

  var html =
    '<div class="modal-header">' +
      '<div>' +
        '<h2>' + escapeHtml(stock.name) + ' <span style="color:var(--text-dim);font-size:14px">(' + escapeHtml(stock.ticker) + ')</span>' +
        '<button class="star-btn ' + (isWatched ? 'active' : '') + '" onclick="toggleWatchlist(\'' + escapeHtml(stock.ticker) + '\');showDetail(\'' + escapeHtml(stock.ticker) + '\')" style="font-size:20px;vertical-align:middle">â­</button>' +
        '</h2>' +
        '<div style="margin-top:8px;display:flex;gap:16px;font-size:13px;align-items:center;">' +
          '<span>ì¢…í•©: <b style="color:' + getScoreColor(stock.total_score) + '">' + stock.total_score + 'ì </b></span>' +
          '<span class="signal-badge ' + getSignalClass(stock.signal) + '">' + escapeHtml(stock.signal) + '</span>' +
          persistHtml +
        '</div>' +
      '</div>' +
      '<button class="modal-close" onclick="closeModal()">&times;</button>' +
    '</div>' +

    '<div style="display:flex;gap:16px;margin-bottom:16px;font-size:12px;color:var(--text-dim);flex-wrap:wrap">' +
      '<span>ì‹œì´: <b style="color:var(--cyan)">' + escapeHtml(stock.market_cap_fmt || 'N/A') + '</b></span>' +
      '<span>Float: <b style="color:var(--cyan)">' + floatDisplay + '</b></span>' +
      '<span>ATR: <b style="color:var(--cyan)">' + (stock.atr_pct != null ? stock.atr_pct + '%' : 'N/A') + '</b></span>' +
      '<span>ì„¹í„°: <b>' + escapeHtml(stock.sector || 'N/A') + '</b></span>' +
      (stock.sector_alpha != null ? '<span>ì„¹í„°Î±: <b style="color:' + (stock.sector_alpha > 0 ? 'var(--green)' : 'var(--red)') + '">' + (stock.sector_alpha > 0 ? '+' : '') + stock.sector_alpha + '%</b></span>' : '') +
      shortHtml +
      weeklyHtml +
    '</div>' +

    '<div style="display:grid;grid-template-columns:repeat(5,1fr);gap:10px;margin-bottom:20px;text-align:center;">' +
      '<div style="background:var(--bg2);border-radius:8px;padding:12px;">' +
        '<div style="font-size:11px;color:var(--text-dim)">ë³€ë™ì„±</div>' +
        '<div style="font-size:20px;font-weight:700;margin-top:4px;color:' + getScoreColor(stock.volatility_score || 0) + '">' + (stock.volatility_score || '-') + '</div>' +
      '</div>' +
      '<div style="background:var(--bg2);border-radius:8px;padding:12px;">' +
        '<div style="font-size:11px;color:var(--text-dim)">ë§¤ì§‘</div>' +
        '<div style="font-size:20px;font-weight:700;margin-top:4px;color:' + getScoreColor(stock.accum_score || 0) + '">' + (stock.accum_score || '-') + '</div>' +
      '</div>' +
      '<div style="background:var(--bg2);border-radius:8px;padding:12px;">' +
        '<div style="font-size:11px;color:var(--text-dim)">íŒ¨í„´</div>' +
        '<div style="font-size:20px;font-weight:700;margin-top:4px;color:' + getScoreColor(stock.pattern_score || 0) + '">' + (stock.pattern_score || '-') + '</div>' +
      '</div>' +
      '<div style="background:var(--bg2);border-radius:8px;padding:12px;">' +
        '<div style="font-size:11px;color:var(--text-dim)">ê¸°ìˆ </div>' +
        '<div style="font-size:20px;font-weight:700;margin-top:4px;color:' + getScoreColor(stock.tech_score || 0) + '">' + (stock.tech_score || '-') + '</div>' +
      '</div>' +
      '<div style="background:var(--bg2);border-radius:8px;padding:12px;">' +
        '<div style="font-size:11px;color:var(--text-dim)">ì£¼ë´‰</div>' +
        '<div style="font-size:20px;font-weight:700;margin-top:4px;color:' + getScoreColor(stock.weekly_score || 0) + '">' + (stock.weekly_score || '-') + '</div>' +
      '</div>' +
    '</div>' +

    flagsHtml +

    '<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:20px;text-align:center;">' +
      '<div style="background:var(--bg2);border-radius:8px;padding:12px;">' +
        '<div style="font-size:11px;color:var(--text-dim)">1ì¼ ìˆ˜ìµë¥ </div>' +
        '<div class="return-cell" style="font-size:18px;margin-top:4px">' + formatReturn(stock.return_1d) + '</div>' +
      '</div>' +
      '<div style="background:var(--bg2);border-radius:8px;padding:12px;">' +
        '<div style="font-size:11px;color:var(--text-dim)">5ì¼ ìˆ˜ìµë¥ </div>' +
        '<div class="return-cell" style="font-size:18px;margin-top:4px">' + formatReturn(stock.return_5d) + '</div>' +
      '</div>' +
      '<div style="background:var(--bg2);border-radius:8px;padding:12px;">' +
        '<div style="font-size:11px;color:var(--text-dim)">20ì¼ ìˆ˜ìµë¥ </div>' +
        '<div class="return-cell" style="font-size:18px;margin-top:4px">' + formatReturn(stock.return_20d) + '</div>' +
      '</div>' +
    '</div>';

  if (stock.details) {
    html += renderDetailSection('ë³€ë™ì„± í”„ë¡œíŒŒì¼', stock.details.volatility);
    html += renderDetailSection('ë§¤ì§‘ ê°ì§€', stock.details.accumulation);
    html += renderDetailSection('ì°¨íŠ¸ íŒ¨í„´', stock.details.pattern);
    html += renderDetailSection('ê¸°ìˆ  ëª¨ë©˜í…€', stock.details.technical);
    html += renderDetailSection('ì£¼ë´‰ ì¶”ì„¸', stock.details.weekly);
  } else {
    html += '<div style="padding:20px;text-align:center;color:var(--text-dim)">ìƒì„¸ ë°ì´í„° ì—†ìŒ (ìƒìœ„ 500ê°œ ì¢…ëª©ë§Œ ì œê³µ)</div>';
  }

  html += '<div style="margin-top:16px;padding:12px;background:var(--bg2);border-radius:8px;font-size:12px;color:var(--text-dim)">' +
    'ë³¸ ë¶„ì„ì€ ì°¸ê³ ìš©ì´ë©° íˆ¬ì íŒë‹¨ì˜ ì±…ì„ì€ ë³¸ì¸ì—ê²Œ ìˆìŠµë‹ˆë‹¤.' +
  '</div>';

  document.getElementById('modalContent').innerHTML = html;
  document.getElementById('modalOverlay').classList.add('show');
}

function closeModal() {
  document.getElementById('modalOverlay').classList.remove('show');
}

function exportCSV() {
  var headers = ['Rank','Ticker','Name','Score','Signal','Price','MarketCap','Sector','1D%','5D%','20D%','VolumeRatio','V','A','P','T','Weekly','ShortInterest','SignalDays','IsNew'];
  var rows = allStocks.map(function(s, i) {
    return [
      i+1, s.ticker, '"' + (s.name || '').replace(/"/g, '""') + '"', s.total_score, '"' + (s.signal || '') + '"',
      s.price, '"' + (s.market_cap_fmt || '') + '"', '"' + (s.sector || '') + '"',
      s.return_1d, s.return_5d, s.return_20d, s.volume_ratio,
      s.volatility_score || '', s.accum_score || '', s.pattern_score || '', s.tech_score || '',
      s.weekly_score || '', s.short_interest || '', s.signal_days || 0, s.is_new ? 'Y' : 'N'
    ].join(',');
  });
  var csv = '\uFEFF' + [headers.join(',')].concat(rows).join('\n');
  var blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  var url = URL.createObjectURL(blob);
  var a = document.createElement('a');
  a.href = url;
  a.download = 'surge-analysis-' + new Date().toISOString().slice(0, 10) + '.csv';
  a.click();
  URL.revokeObjectURL(url);
}

function toggleTheme() {
  var root = document.documentElement;
  var isLight = root.getAttribute('data-theme') === 'light';
  if (isLight) {
    root.removeAttribute('data-theme');
    document.getElementById('themeBtn').textContent = 'ğŸŒ™';
    localStorage.setItem('surge_theme', 'dark');
  } else {
    root.setAttribute('data-theme', 'light');
    document.getElementById('themeBtn').textContent = 'â˜€ï¸';
    localStorage.setItem('surge_theme', 'light');
  }
}

function initTheme() {
  var saved = localStorage.getItem('surge_theme');
  if (saved === 'light') {
    document.documentElement.setAttribute('data-theme', 'light');
    document.getElementById('themeBtn').textContent = 'â˜€ï¸';
  }
}

function setupAutoRefresh() {
  if (refreshTimer) clearInterval(refreshTimer);
  var mins = 30;
  var refreshBar = document.getElementById('refreshBar');
  var lastRefresh = Date.now();

  refreshTimer = setInterval(function() {
    var elapsed = Math.round((Date.now() - lastRefresh) / 60000);
    var remaining = mins - elapsed;
    if (remaining <= 0) {
      lastRefresh = Date.now();
      loadData();
      refreshBar.textContent = 'ìë™ ìƒˆë¡œê³ ì¹¨ ì™„ë£Œ';
    } else {
      refreshBar.textContent = 'ë‹¤ìŒ ìƒˆë¡œê³ ì¹¨: ' + remaining + 'ë¶„ í›„';
    }
  }, 60000);

  refreshBar.textContent = '30ë¶„ë§ˆë‹¤ ìë™ ìƒˆë¡œê³ ì¹¨';
}

// ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
document.querySelectorAll('.filter-btn').forEach(function(btn) {
  btn.addEventListener('click', function() {
    document.querySelectorAll('.filter-btn').forEach(function(b) { b.classList.remove('active'); });
    btn.classList.add('active');
    currentFilter = btn.dataset.filter;
    displayCount = 100;
    renderTable(allStocks);
  });
});

document.getElementById('searchBox').addEventListener('input', function() {
  displayCount = 100;
  renderTable(allStocks);
});

document.querySelectorAll('thead th[data-sort]').forEach(function(th) {
  th.addEventListener('click', function() {
    var key = th.dataset.sort;
    if (key === 'rank') { currentSort = { key: 'total_score', desc: true }; }
    else if (currentSort.key === key) { currentSort.desc = !currentSort.desc; }
    else { currentSort = { key: key, desc: true }; }
    document.querySelectorAll('thead th').forEach(function(t) { t.classList.remove('sorted'); });
    th.classList.add('sorted');
    renderTable(allStocks);
  });
});

document.getElementById('modalOverlay').addEventListener('click', function(e) {
  if (e.target === document.getElementById('modalOverlay')) closeModal();
});

document.addEventListener('keydown', function(e) { if (e.key === 'Escape') closeModal(); });

// ì´ˆê¸°í™”
initTheme();
loadData();
</script>

</body>
</html>
